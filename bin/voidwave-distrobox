#!/usr/bin/env bash
#═══════════════════════════════════════════════════════════════════════════════
#
#    VOIDWAVE DISTROBOX HELPER v10.0.0
#    Manage VOIDWAVE containers for immutable systems
#
#    Copyright (c) 2025 Nerds489
#    Licensed under the Apache License, Version 2.0
#
#    For systems like Bazzite, SteamOS, Fedora Silverblue, etc.
#    This script creates and manages a containerized pentesting environment
#    that persists across system updates.
#
#═══════════════════════════════════════════════════════════════════════════════

set -euo pipefail

# Configuration
CONTAINER_NAME="${VOIDWAVE_CONTAINER_NAME:-voidwave-box}"
DEFAULT_IMAGE="${VOIDWAVE_DEFAULT_IMAGE:-kalilinux/kali-rolling}"

# Colors
if [[ -t 1 ]] && [[ "${NO_COLOR:-}" != "1" ]]; then
    C_RESET='\033[0m'
    C_RED='\033[0;31m'
    C_GREEN='\033[0;32m'
    C_YELLOW='\033[0;33m'
    C_CYAN='\033[0;36m'
    C_BOLD='\033[1m'
else
    C_RESET='' C_RED='' C_GREEN='' C_YELLOW='' C_CYAN='' C_BOLD=''
fi

# Output helpers
log_info()    { echo -e "${C_CYAN}[INFO]${C_RESET} $*"; }
log_ok()      { echo -e "${C_GREEN}[OK]${C_RESET}   $*"; }
log_warn()    { echo -e "${C_YELLOW}[WARN]${C_RESET} $*"; }
log_error()   { echo -e "${C_RED}[ERROR]${C_RESET} $*" >&2; }

# Check if distrobox is available
check_distrobox() {
    if ! command -v distrobox &>/dev/null; then
        log_error "Distrobox is not installed"
        echo
        echo "Install distrobox using one of these methods:"
        echo
        echo "  ${C_CYAN}# Using the official installer (recommended):${C_RESET}"
        echo "  curl -s https://raw.githubusercontent.com/89luca89/distrobox/main/install | sh -s -- --prefix ~/.local"
        echo
        echo "  ${C_CYAN}# Or via your package manager:${C_RESET}"
        echo "  # Fedora/rpm-ostree: rpm-ostree install distrobox"
        echo "  # Arch: pacman -S distrobox"
        echo "  # Ubuntu/Debian: apt install distrobox"
        echo
        exit 1
    fi
}

# Check if podman or docker is available
check_container_runtime() {
    if ! command -v podman &>/dev/null && ! command -v docker &>/dev/null; then
        log_error "No container runtime found (podman or docker required)"
        echo
        echo "Install a container runtime:"
        echo
        echo "  ${C_CYAN}# Podman (recommended for rootless):${C_RESET}"
        echo "  # Fedora/rpm-ostree: rpm-ostree install podman"
        echo "  # Arch: pacman -S podman"
        echo "  # Ubuntu/Debian: apt install podman"
        echo
        exit 1
    fi
}

# Check if container exists
container_exists() {
    distrobox list 2>/dev/null | grep -q "^${CONTAINER_NAME} "
}

# Show banner
show_banner() {
    echo -e "${C_CYAN}"
    cat << 'BANNER'
╔═══════════════════════════════════════════════════════════════╗
║           VOIDWAVE DISTROBOX HELPER                           ║
║           Containerized Pentesting for Immutable Systems      ║
╚═══════════════════════════════════════════════════════════════╝
BANNER
    echo -e "${C_RESET}"
}

# Create the container
cmd_create() {
    local image="${1:-$DEFAULT_IMAGE}"

    check_distrobox
    check_container_runtime

    if container_exists; then
        log_warn "Container '$CONTAINER_NAME' already exists"
        echo "Use 'voidwave-distrobox enter' to enter it"
        echo "Or 'voidwave-distrobox remove' to remove it first"
        return 1
    fi

    log_info "Creating container '$CONTAINER_NAME' with image '$image'..."

    # Create the container with additional capabilities for network tools
    distrobox create \
        --name "$CONTAINER_NAME" \
        --image "$image" \
        --additional-flags "--cap-add=NET_ADMIN --cap-add=NET_RAW" \
        --yes

    log_ok "Container created successfully!"
    echo
    echo "Next steps:"
    echo "  ${C_CYAN}voidwave-distrobox enter${C_RESET}    # Enter the container"
    echo "  ${C_CYAN}voidwave-distrobox setup${C_RESET}    # Install VOIDWAVE tools"
}

# Enter the container
cmd_enter() {
    check_distrobox

    if ! container_exists; then
        log_error "Container '$CONTAINER_NAME' does not exist"
        echo "Create it first with: voidwave-distrobox create"
        return 1
    fi

    log_info "Entering container '$CONTAINER_NAME'..."
    distrobox enter "$CONTAINER_NAME"
}

# Install VOIDWAVE tools inside the container
cmd_setup() {
    check_distrobox

    if ! container_exists; then
        log_error "Container '$CONTAINER_NAME' does not exist"
        echo "Create it first with: voidwave-distrobox create"
        return 1
    fi

    log_info "Setting up VOIDWAVE tools in container..."

    # Determine package manager based on image
    local setup_script='
        set -e

        # Update package lists
        if command -v apt-get &>/dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y aircrack-ng nmap hashcat john hydra nikto gobuster \
                tcpdump wireshark tshark reaver bully mdk4 hcxdumptool hcxtools \
                python3-pip git curl wget
        elif command -v pacman &>/dev/null; then
            sudo pacman -Sy --noconfirm
            sudo pacman -S --noconfirm --needed aircrack-ng nmap hashcat john hydra nikto \
                gobuster tcpdump wireshark-cli reaver bully mdk4 hcxdumptool hcxtools \
                python-pip git curl wget
        elif command -v dnf &>/dev/null; then
            sudo dnf install -y aircrack-ng nmap hashcat john hydra nikto \
                tcpdump wireshark-cli python3-pip git curl wget
        else
            echo "Unknown package manager - please install tools manually"
            exit 1
        fi

        echo
        echo "Basic tools installed. For more tools, run inside the container:"
        echo "  sudo apt install metasploit-framework  # Kali/Parrot"
        echo "  pip3 install --user theHarvester shodan"
    '

    distrobox enter "$CONTAINER_NAME" -- bash -c "$setup_script"

    log_ok "Setup complete!"
}

# Remove the container
cmd_remove() {
    check_distrobox

    if ! container_exists; then
        log_warn "Container '$CONTAINER_NAME' does not exist"
        return 0
    fi

    echo -ne "${C_YELLOW}Remove container '$CONTAINER_NAME'? [y/N]${C_RESET} "
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        log_info "Cancelled"
        return 0
    fi

    log_info "Removing container '$CONTAINER_NAME'..."
    distrobox rm "$CONTAINER_NAME" --force

    log_ok "Container removed"
}

# Stop the container
cmd_stop() {
    check_distrobox

    if ! container_exists; then
        log_warn "Container '$CONTAINER_NAME' does not exist"
        return 0
    fi

    log_info "Stopping container '$CONTAINER_NAME'..."
    distrobox stop "$CONTAINER_NAME" --yes

    log_ok "Container stopped"
}

# Show container status
cmd_status() {
    check_distrobox

    echo
    echo -e "${C_BOLD}Container: ${C_CYAN}$CONTAINER_NAME${C_RESET}"
    echo

    if container_exists; then
        # Get container info
        local info
        info=$(distrobox list 2>/dev/null | grep "^${CONTAINER_NAME} " || true)

        if [[ -n "$info" ]]; then
            echo -e "  ${C_GREEN}Status:${C_RESET} Exists"

            # Check if running
            if podman ps 2>/dev/null | grep -q "$CONTAINER_NAME" || \
               docker ps 2>/dev/null | grep -q "$CONTAINER_NAME"; then
                echo -e "  ${C_GREEN}Running:${C_RESET} Yes"
            else
                echo -e "  ${C_YELLOW}Running:${C_RESET} No"
            fi

            # Show image
            local image
            image=$(echo "$info" | awk '{print $2}')
            echo -e "  ${C_CYAN}Image:${C_RESET} $image"
        fi
    else
        echo -e "  ${C_RED}Status:${C_RESET} Not created"
        echo
        echo "Create with: voidwave-distrobox create"
    fi

    echo
}

# Export a command from the container to the host
cmd_export() {
    local app="${1:-}"

    if [[ -z "$app" ]]; then
        log_error "Usage: voidwave-distrobox export <application>"
        echo
        echo "Export an application from the container to your host."
        echo "This creates a wrapper in ~/.local/bin that runs the app in the container."
        echo
        echo "Examples:"
        echo "  voidwave-distrobox export nmap"
        echo "  voidwave-distrobox export hashcat"
        return 1
    fi

    check_distrobox

    if ! container_exists; then
        log_error "Container '$CONTAINER_NAME' does not exist"
        return 1
    fi

    log_info "Exporting '$app' from container..."
    distrobox enter "$CONTAINER_NAME" -- distrobox-export --app "$app" 2>/dev/null || \
    distrobox enter "$CONTAINER_NAME" -- distrobox-export --bin "/usr/bin/$app" --export-path ~/.local/bin

    log_ok "Exported '$app' to ~/.local/bin/"
    echo "Make sure ~/.local/bin is in your PATH"
}

# Show help
show_help() {
    show_banner

    cat << EOF
${C_BOLD}USAGE:${C_RESET}
    voidwave-distrobox <command> [options]

${C_BOLD}COMMANDS:${C_RESET}
    create [image]    Create the VOIDWAVE container
                      Default image: $DEFAULT_IMAGE
    enter             Enter the container shell
    setup             Install VOIDWAVE tools in the container
    stop              Stop the running container
    remove            Remove the container
    status            Show container status
    export <app>      Export an app from container to host
    help              Show this help

${C_BOLD}ENVIRONMENT VARIABLES:${C_RESET}
    VOIDWAVE_CONTAINER_NAME    Container name (default: voidwave-box)
    VOIDWAVE_DEFAULT_IMAGE     Default image (default: kalilinux/kali-rolling)

${C_BOLD}ALTERNATIVE IMAGES:${C_RESET}
    kalilinux/kali-rolling     Kali Linux (recommended for pentesting)
    archlinux                  Arch Linux (BlackArch repos available)
    parrotsec/security         Parrot Security
    docker.io/library/debian   Debian (lightweight)

${C_BOLD}EXAMPLES:${C_RESET}
    # Quick start
    voidwave-distrobox create
    voidwave-distrobox setup
    voidwave-distrobox enter

    # Use a different image
    voidwave-distrobox create archlinux

    # Export nmap to use from host
    voidwave-distrobox export nmap
    nmap --version  # Works from host now!

${C_BOLD}WHY USE THIS?${C_RESET}
    On immutable systems (Bazzite, SteamOS, Silverblue), system packages
    are reset on updates. Distrobox provides a persistent container where
    you can install pentesting tools that survive system updates.

    The container has full access to your home directory and network,
    making it seamless to use for security testing.

EOF
}

# Main
main() {
    case "${1:-help}" in
        create)
            show_banner
            cmd_create "${2:-}"
            ;;
        enter)
            cmd_enter
            ;;
        setup)
            show_banner
            cmd_setup
            ;;
        stop)
            cmd_stop
            ;;
        remove|rm|delete)
            cmd_remove
            ;;
        status)
            show_banner
            cmd_status
            ;;
        export)
            cmd_export "${2:-}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $1"
            echo "Run 'voidwave-distrobox help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
